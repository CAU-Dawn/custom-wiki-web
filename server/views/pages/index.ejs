<!DOCTYPE HTML>

<html>
<head>
    <title><%= title %></title>
    <%include ../partials/stylesheet %>
    <% include ../partials/ck %>
</head>
<body>
    <% include ../partials/nav %>
    <div class="container">
        <div class="page-header">
            <h1>ISWIKI</h1>
        </div>
        <div class="notice">
            <%if(status == 0){%>
                <a href="/create" class="btn btn-primary">Create</a>
            <%} else {%>
            <button id="edit" class="btn btn-primary" onclick="edit()" type="button" style="display:inline">Edit</button>
            <%}%>
            <button id="submit" class="btn btn-primary" onclick="submit()" type="button" style="display:none">Submit</button>
            <div>
                <h1><%- title %></h1>
            </div>
            <div id="editor">
                <%- data %> 
            </div>
        </div>
        <div class="recent-changes">
            <div class="page-header">
                <h3>Recent Changes</h3>
            </div>
            <!--동적으로 recent-changes control-->
            <!--recent-changes라는 테이블 (즉 title에 관계없이 시간순으로 정렬된 모든 위키)이 필요할듯.-->
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Number</th>
                        <th>Title</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                <%if(contents.length>0){%>
                    <%var i = 0;%>
                    <%contents.forEach(function(item){%>
                    <%i++;%>
                    <%if(i>5) return %>
                    <tr>
                        <td class="number"><%=item.number%></td>
                        <td class="title"><a href="/show?id=<%=item.title%>"><%=item.title%></a></td>
                        <td class="date"><%=item.date%></td>
                    </tr>
                    <%})%>
                    <%} else {%>
                    <tr>
                        <td colspan="5">게시물이 없습니다.</td>
                    </tr>
                <%}%>
                </tbody>
            </table>
        </div>
    </div>
    <script type="text/javascript">

    var edit = function(){
        var submit_button = document.getElementById("submit");
        submit_button.style.display = "inline";
        var edit_button = document.getElementById("edit");
        edit_button.style.display = "none";

        var editor = document.getElementById('editor');
        CKEDITOR.disableAutoInline = true;
        CKEDITOR.replace('editor'); // classic
        editor.contentEditable = true;
        
    };
    var submit = function(){
        var edit_button = document.getElementById("edit");
        edit_button.style.display = "inline";
        var submit_button = document.getElementById("submit");
        submit_button.style.display = "none";

        var contents = CKEDITOR.instances.editor.getData();
        var editor = document.getElementById('editor');
        
        console.log(contents);
        
        $.ajax({
            url: '/',
            type: 'post',
            data: {"contents": contents, "title":"Door"},
            dataType: 'JSON',
            success: function(result) //result객체 반환 되는거 봐야함.
            {
                console.log(result);
                if ( result.status == 1 ) {
                    CKEDITOR.instances.editor.destroy();
                    editor.contentEditable = false;
                    //controller render로 처리.
                } else {
                    alert("Do not change Title")
                    CKEDITOR.instances.editor.destroy();
                    editor.contentEditable = false;
                }
            }
        })
    };
    </script>

    <% include ../partials/footer %>
    <% include ../partials/javascript %>

</body>
</html>
